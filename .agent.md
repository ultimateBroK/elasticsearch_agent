# 🤖 Elasticsearch Agent - Developer Guide

## 📋 Project Overview

**Purpose**: AI-powered agent that enables natural language querying of Elasticsearch data with intelligent visualization capabilities.

**Architecture**: Full-stack application with AI agent backend and modern React frontend, now production-ready with comprehensive deployment infrastructure.

**Status**: Phase 1 (MVP) ~90% complete, Phase 2 (Intelligence Layer) ~15% complete.

## 🛠️ Tech Stack

### Backend (Python)
- **Framework**: FastAPI with async/await
- **AI Agent**: LangGraph + Google Gemini API
- **Database**: Elasticsearch (primary data), Redis (memory/cache)
- **Package Manager**: UV (ultra-fast Python dependency management)
- **Key Libraries**: 
  - `elasticsearch>=8.0` (official ES client)
  - `langgraph>=0.4.8` (agent workflow)
  - `google-genai>=1.21.1` (LLM integration)
  - `redis>=6.2.0` (memory store)
  - `pandas>=2.3.0` (data processing)

### Frontend (TypeScript/React)
- **Framework**: Next.js 15 with App Router
- **Runtime**: Bun (5x faster than npm)
- **Styling**: TailwindCSS 4 + Shadcn/ui components
- **State Management**: Zustand (lightweight, simple)
- **Data Fetching**: TanStack Query + WebSocket
- **Visualization**: ECharts + echarts-for-react
- **Key Libraries**:
  - `next@15.3.4` (React framework)
  - `zustand@5.0.5` (state management)
  - `echarts@5.6.0` (charts)
  - `socket.io-client@4.8.1` (real-time)

### Infrastructure
- **Development**: Docker Compose (ES + Redis)
- **Deployment**: Vercel (frontend) + Railway (backend) (planned for Phase 4)

## 📁 Project Structure

```
elasticsearch_agent/
├── backend/                    # Python FastAPI backend
│   ├── app/
│   │   ├── agents/            # LangGraph AI agents
│   │   │   └── elasticsearch_agent.py  # Main agent logic
│   │   ├── api/               # FastAPI routes & WebSocket
│   │   │   ├── routes.py      # REST API endpoints
│   │   │   └── websocket.py   # Real-time communication
│   │   ├── models/            # Pydantic schemas
│   │   │   └── schemas.py     # Request/response models
│   │   ├── services/          # External service integrations
│   │   │   ├── elasticsearch.py  # ES client & operations
│   │   │   ├── gemini.py      # Google Gemini LLM service
│   │   │   └── redis.py       # Redis memory/cache service
│   │   └── utils/             # Helper functions
│   │       ├── logging.py     # Basic logging
│   │       └── sample_data.py # Test data utilities
│   ├── scripts/               # Utility scripts
│   │   ├── ingest_sample_data.py  # Data ingestion
│   │   └── test_gemini.py     # LLM testing
│   ├── main.py               # FastAPI app entry point
│   ├── pyproject.toml        # UV dependencies
│   └── uv.lock              # Dependency lockfile
├── frontend/                  # Next.js React frontend
│   ├── src/
│   │   ├── app/              # Next.js App Router
│   │   │   ├── page.tsx      # Main chat interface
│   │   │   ├── layout.tsx    # Root layout
│   │   │   └── globals.css   # Global styles
│   │   ├── components/       # React components
│   │   │   ├── chat/         # Chat interface components
│   │   │   │   ├── ChatInterface.tsx    # Main chat container
│   │   │   │   ├── MessageList.tsx      # Message display
│   │   │   │   ├── MessageInput.tsx     # User input
│   │   │   │   └── ChatMessage.tsx      # Individual messages
│   │   │   ├── charts/       # Chart visualization components
│   │   │   │   └── ChartRenderer.tsx    # ECharts integration
│   │   │   └── ui/           # Shadcn/ui components
│   │   ├── hooks/            # Custom React hooks
│   │   │   └── useWebSocket.ts  # WebSocket connection
│   │   ├── lib/              # Utilities
│   │   │   ├── api.ts        # REST API client
│   │   │   └── utils.ts      # Helper functions
│   │   └── store/            # State management
│   │       └── chatStore.ts  # Zustand chat state
│   ├── package.json          # Bun dependencies
│   └── bun.lock             # Dependency lockfile
├── docker-compose.yml       # Development ES + Redis
├── .env.example            # Environment configuration template
├── plan.md                 # Implementation roadmap
├── techstack.md           # Detailed tech decisions
├── SETUP.md              # Setup instructions
└── PHASE_REVIEW.md      # Progress tracking
```

## 🚀 Quick Start

### Prerequisites
- Python 3.11+
- Node.js 18+ (or Bun)
- Docker & Docker Compose
- Google Gemini API Key

### 1. Infrastructure Setup
```bash
# Start Elasticsearch + Redis
docker-compose up -d

# Verify services are running
docker-compose ps
```

### 2. Environment Setup
```bash
# Generate and create all environment files
./scripts/setup-env.sh generate
./scripts/setup-env.sh create

# Edit with your actual API key
nano .env
# Set: GOOGLE_API_KEY=your_actual_gemini_api_key_here

# Validate configuration
./scripts/setup-env.sh validate
```

### 3. Backend Setup
```bash
cd backend

# Install UV (if not installed)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install dependencies
uv sync

# Run development server
uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 4. Frontend Setup
```bash
cd frontend

# Install Bun (if not installed)
curl -fsSL https://bun.sh/install | bash

# Install dependencies
bun install

# Run development server
bun dev
```

### 5. Access Application
- **Frontend**: http://localhost:3000
- **Backend API**: http://localhost:8000
- **API Docs**: http://localhost:8000/docs
- **Elasticsearch**: http://localhost:9200
- **Redis**: localhost:6379

## 📊 Chart Visualization

The application now includes comprehensive chart visualization using ECharts:

### Supported Chart Types
- **Bar Charts**: For categorical data comparison
- **Line Charts**: For time series and trend analysis  
- **Pie Charts**: For proportional data visualization
- **Scatter Plots**: For correlation analysis
- **Area Charts**: For cumulative data visualization

### Chart Features
- **Auto-detection**: Automatically suggests chart types based on data
- **Field mapping**: Smart field suggestions for axes and labels
- **Responsive design**: Charts adapt to container size
- **Interactive tooltips**: Hover for detailed information

## 🔧 Development Guidelines

### Code Style & Standards
- **Python**: Use `black` for formatting, `ruff` for linting
- **TypeScript**: Follow Next.js conventions, use TypeScript strict mode
- **Async/Await**: Prefer async patterns throughout the stack
- **Error Handling**: Always include proper error handling and logging

### Environment Configuration
Create `.env` files in both `backend/` and `frontend/` directories:

**Backend `.env`:**
```bash
# Required
GOOGLE_API_KEY=your_gemini_api_key_here

# Optional (defaults shown)
ELASTICSEARCH_HOST=localhost
ELASTICSEARCH_PORT=9200
ELASTICSEARCH_SCHEME=http
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
LOG_LEVEL=INFO
FRONTEND_URL=http://localhost:3000
```

**Frontend `.env.local`:**
```bash
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws
```

### Key Development Commands

**Backend:**
```bash
# Run with auto-reload
uv run uvicorn main:app --reload

# Run tests
uv run pytest

# Format code
uv run black .
uv run ruff check .

# Install new dependency
uv add package_name

# Build Docker image
docker build -t elasticsearch-agent-backend .
```

**Frontend:**
```bash
# Development server
bun dev

# Build for production
bun run build

# Type checking
bun run type-check

# Install new dependency
bun add package_name

# Build Docker image
docker build -t elasticsearch-agent-frontend .
```

**Chart Development:**
```bash
# Test chart rendering
# Add sample data to test different chart types
cd backend
uv run python scripts/ingest_sample_data.py

# Frontend chart development
cd frontend
bun dev
# Navigate to http://localhost:3000 and test chart queries
```

## 🏗️ Architecture Patterns

### Agent Workflow (LangGraph)
The AI agent follows a structured workflow:
1. **Get Indices**: List available Elasticsearch indices
2. **Analyze Intent**: Parse user query for intent and requirements
3. **Generate Query**: Create Elasticsearch query from natural language
4. **Execute Query**: Run query against Elasticsearch
5. **Generate Response**: Format results and create visualizations

### Communication Patterns
- **REST API**: Traditional request/response for simple operations
- **WebSocket**: Real-time bidirectional communication for chat
- **State Management**: Zustand for client-side state, Redis for server-side memory

### Data Flow
```
User Input → Frontend (Zustand) → WebSocket/REST → FastAPI → LangGraph Agent → Gemini LLM → Elasticsearch → Response → Frontend (Charts)
```

## 🧪 Testing & Debugging

### Health Checks
- **Backend Health**: `GET /api/v1/health`
- **Elasticsearch**: `curl http://localhost:9200/_cluster/health`
- **Redis**: `redis-cli ping`

### Sample Data
```bash
# Ingest test data
cd backend
uv run python scripts/ingest_sample_data.py
```

### Common Issues & Solutions

**Elasticsearch Connection Issues:**
- Verify Docker containers are running: `docker-compose ps`
- Check ES health: `curl http://localhost:9200/_cluster/health`
- Review logs: `docker-compose logs elasticsearch`

**Gemini API Issues:**
- Verify API key is set: `echo $GOOGLE_API_KEY`
- Test API directly: `uv run python scripts/test_gemini.py`
- Check quota limits in Google AI Studio

**WebSocket Connection Issues:**
- Verify backend is running on port 8000
- Check browser console for WebSocket errors
- Fallback to REST API mode if WebSocket fails

## 📊 Current Status & Next Steps

### ✅ Completed (Phase 1 - MVP)
- [x] Project structure and infrastructure
- [x] FastAPI backend with async operations
- [x] Next.js frontend with modern UI
- [x] LangGraph agent with enhanced workflow
- [x] Elasticsearch integration with error handling
- [x] Redis memory store with caching
- [x] WebSocket real-time communication
- [x] Enhanced chat interface with validation
- [x] Basic health monitoring
- [x] **ECharts visualization integration**
- [x] **5 chart types: bar, line, pie, scatter, area**
- [x] **Chart configuration generation**
- [x] **Smart field mapping and suggestions**

### 🚧 In Progress
- [ ] **CRITICAL**: Need real Google API key for Gemini
- [ ] Advanced query pattern recognition
- [ ] Chart recommendation engine (basic version)

### 🔮 Planned (Phase 2 - Intelligence Layer)
- [ ] Vector database integration (Chroma)
- [ ] Advanced memory & context management
- [ ] ML-powered chart recommendations
- [ ] Multi-turn conversation capabilities
- [ ] Advanced UI features

### 🔮 Planned (Phase 4 - Production Ready)
- [ ] Production deployment infrastructure
- [ ] Monitoring and observability
- [ ] Security hardening
- [ ] Performance optimization
- [ ] CI/CD pipeline

## 🎯 Best Practices

### Performance
- Use UV for Python dependencies (10-100x faster than pip)
- Use Bun for Node.js operations (5x faster than npm)
- Implement connection pooling for Elasticsearch
- Use Redis for caching and session management

### Security
- Never commit API keys to version control
- Use environment variables for all secrets
- Implement proper CORS configuration
- Validate all user inputs

### Monitoring
- Use structured logging throughout the application
- Monitor Elasticsearch cluster health
- Track WebSocket connection status
- Implement proper error boundaries

### Code Organization
- Keep components small and focused
- Use TypeScript for type safety
- Implement proper error handling
- Write tests for critical functionality
- Follow consistent file naming conventions
- Use structured logging with context
- Implement retry logic for external services
- Use environment-specific configurations

### Chart Development
- Test with different data types and sizes
- Ensure responsive design across devices
- Validate chart configurations before rendering
- Handle edge cases (empty data, invalid fields)
- Use appropriate chart types for data characteristics
- Implement proper error boundaries for chart failures

## 🔗 Useful Resources

### Core Technologies
- **LangGraph Documentation**: https://langchain-ai.github.io/langgraph/
- **Google Gemini API**: https://ai.google.dev/
- **Elasticsearch Python Client**: https://elasticsearch-py.readthedocs.io/
- **FastAPI Documentation**: https://fastapi.tiangolo.com/
- **Next.js Documentation**: https://nextjs.org/docs
- **Shadcn/ui Components**: https://ui.shadcn.com/
- **ECharts Documentation**: https://echarts.apache.org/

### Development Tools
- **UV Package Manager**: https://github.com/astral-sh/uv
- **Bun Runtime**: https://bun.sh/docs
- **Docker Documentation**: https://docs.docker.com/
- **Docker Compose**: https://docs.docker.com/compose/

### Project Documentation
- **SETUP.md**: Development setup instructions
- **plan.md**: Implementation roadmap and progress
- **techstack.md**: Technology decisions and rationale

---

## 📝 Migration Notes

*The following content was migrated from existing project files:*

### From .cursor/rules/basics.mdc:
- Always run "conda activate elastic-agent" before running terminal commands (Note: Now using UV virtual environments)
- Mark completed tasks in plan.md to track progress  
- Reference documentation for accurate code implementation

## 🚨 Important Development Notes

### Environment Setup
- **Use UV instead of conda**: `uv sync` for Python dependencies
- **Use Bun instead of npm**: `bun install` for Node.js dependencies
- **Docker required**: All services run in containers for consistency
- **API Key required**: Google Gemini API key is mandatory for functionality

### MVP Focus
- **Stick to the plan**: Focus on Phase 1 MVP features only
- **Chart visualization**: ECharts integration is now complete
- **Production features**: Deferred to Phase 4 as per plan
- **Core functionality**: Prioritize chat interface and basic queries

### Troubleshooting Quick Reference
- **Service not starting**: Check `docker-compose ps` and logs
- **API errors**: Verify environment variables and API keys
- **WebSocket issues**: Check browser console and backend logs
- **Chart not rendering**: Check data format and chart configuration
- **Gemini API issues**: Verify API key and check quota limits

---

*Last updated: 2025-01-27*
*Project Phase: 1 (MVP) - 90% Complete, Focused on Core Features*